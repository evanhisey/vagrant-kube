---
- name: Playbook for vagrant+kube
  hosts: all
  gather_facts: true
  become: false

  tasks:
    - name: Install Vagrant and Ansible
      ansible.builtin.dnf:
       name:
        - vagrant
        - vagrant-libvirt
        - ansible
       state: installed
      notify: virtnetwork
      become: true

    - name: Force all notified handler to run at this point, not waiting for normal sync points
      ansible.builtin.meta: flush_handlers
    
    - name: Create Kube Vagrant directory
      ansible.builtin.file:
       path: "{{ ansible_env.PWD }}/{{ vagrantDir }}"
       state: directory
       mode: 0755
     
    - name: Populate Kube Vagrant directory
      ansible.builtin.template:
       src: templates/{{ item }}
       dest: "{{ ansible_env.PWD }}/{{ vagrantDir }}/{{ item }}"
       mode: 0755
      loop:
       - bootstrap.yml
       - vagrantfile

    - name: Start Boxes
    # Currently not decent modules for controlling Vagrant from Ansible,
    # so we are going to use a shell command to make things work.
    # Refactor to a role to improve versitality and be more "Ansible"
      ansible.builtin.shell: |
        cd {{ ansible_env.PWD }}/{{ vagrantDir }}
        vagrant up --provision
        cd ~
      register: vagrant_results

    - name: Report results of Vagrant
      ansible.builtin.debug:
        msg: "{{ vagrant_results }}"

  handlers:
    - name: Virtnetwork
      ansible.builtin.systemd:
       name: virtnetworkd
       enabled: true
       state: restarted
      become: true
